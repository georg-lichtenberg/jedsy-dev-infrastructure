# Makefile fÃ¼r die Erstellung von LaTeX/PDF Dokumenten aus Markdown

# Variablen
DOCS_DIR = /Users/georg/projects/jedsy/jedsy-dev-infrastructure/docs
TIMERECORD_DIR = $(DOCS_DIR)/timerecord
MONTH_DIR = $(TIMERECORD_DIR)/month
DAILY_DIR = $(TIMERECORD_DIR)/daily
OUTPUT_DIR = $(TIMERECORD_DIR)/output
TEMPLATE_DIR = $(DOCS_DIR)/templates
PANDOC = pandoc
TEMPLATE = $(TEMPLATE_DIR)/jedsy-report-template.tex
YEAR = $(shell date +%Y)

# Erstelle Ausgabeverzeichnis falls es nicht existiert
$(shell mkdir -p $(OUTPUT_DIR))

# Standard-Ziel: Erstelle alle Monatsberichte des aktuellen Jahres
all: year-reports

# LÃ¶sche alle generierten Dateien des aktuellen Jahres
clean:
	@echo "=== LÃ¶sche alle generierten Dateien fÃ¼r $(YEAR) ==="
	@rm -f $(MONTH_DIR)/$(YEAR)*.csv $(MONTH_DIR)/$(YEAR)*.md $(OUTPUT_DIR)/$(YEAR)*.pdf
	@echo "âœ… Alle Dateien fÃ¼r $(YEAR) gelÃ¶scht"

# Erstelle alle 12 Monate des aktuellen Jahres
year-reports:
	@echo "=== Erstelle Zeiterfassungsberichte fÃ¼r $(YEAR) ==="
	@for month in 01 02 03 04 05 06 07 08 09 10 11 12; do \
		yearmonth="$(YEAR)$$month"; \
		echo "--- Erstelle $$yearmonth ---"; \
		$(DOCS_DIR)/scripts/create_month.sh $(YEAR) $$month; \
		if [ -f "$(MONTH_DIR)/$$yearmonth.md" ]; then \
			pandoc $(MONTH_DIR)/$$yearmonth.md -o $(OUTPUT_DIR)/$$yearmonth.pdf --pdf-engine=xelatex -V geometry:margin=2cm -V documentclass=article -V lang=de 2>/dev/null || echo "PDF-Fehler fÃ¼r $$yearmonth ignoriert"; \
		fi; \
	done
	@echo "âœ… Alle Berichte fÃ¼r $(YEAR) erstellt!"
	@echo "ðŸ“Š CSV-Dateien: $(MONTH_DIR)/$(YEAR)*.csv"
	@echo "ðŸ“„ Markdown: $(MONTH_DIR)/$(YEAR)*.md"
	@echo "ðŸ“‘ PDF-Berichte: $(OUTPUT_DIR)/$(YEAR)*.pdf"

# Alle Monatsberichte erstellen
months: $(MONTH_PDFS)

# Regel fÃ¼r die Erstellung eines Monats-PDF aus einer .md-Datei
$(OUTPUT_DIR)/%.pdf: $(MONTH_DIR)/%.md
	@echo "Erstelle PDF fÃ¼r Monat $*"
	@$(DOCS_DIR)/scripts/better_pdf.sh $< $@

# Erstellt das PDF fÃ¼r den aktuellen Monat (Jahr und Monat werden abgefragt)
current-month:
	@read -p "Jahr-Monat (Format YYYYMM, z.B. 202510 fÃ¼r Oktober 2025): " yearmonth; \
	if [ ! -f "$(MONTH_DIR)/$$yearmonth.md" ]; then \
		echo "Fehler: Die Datei $(MONTH_DIR)/$$yearmonth.md existiert nicht."; \
		exit 1; \
	fi; \
	$(DOCS_DIR)/scripts/better_pdf.sh $(MONTH_DIR)/$$yearmonth.md $(OUTPUT_DIR)/$$yearmonth.pdf

# Erstellt ein tÃ¤gliches Berichts-PDF
daily:
	@read -p "Datum (Format YYYYMMDD, z.B. 20251014 fÃ¼r 14. Oktober 2025): " date; \
	if [ ! -f "$(DAILY_DIR)/$$date.md" ]; then \
		echo "Warnung: Die Datei $(DAILY_DIR)/$$date.md existiert nicht."; \
		echo "MÃ¶chten Sie eine neue Datei basierend auf der Vorlage erstellen? (j/n) "; \
		read answer; \
		if [ "$$answer" = "j" ]; then \
			cp $(DAILY_DIR)/template.md $(DAILY_DIR)/$$date.md; \
			echo "Tagesprotokoll-Vorlage nach $(DAILY_DIR)/$$date.md kopiert."; \
			echo "Bitte fÃ¼llen Sie die Datei aus und fÃ¼hren Sie diesen Befehl erneut aus."; \
		fi; \
		exit 1; \
	fi; \
	$(DOCS_DIR)/scripts/better_pdf.sh $(DAILY_DIR)/$$date.md $(OUTPUT_DIR)/$$date.pdf

# Neues Tagesprotokoll erstellen
new-daily:
	@read -p "Datum (Format YYYYMMDD, z.B. 20251014 fÃ¼r 14. Oktober 2025): " date; \
	if [ -f "$(DAILY_DIR)/$$date.md" ]; then \
		echo "Die Datei $(DAILY_DIR)/$$date.md existiert bereits."; \
		echo "MÃ¶chten Sie sie Ã¼berschreiben? (j/n) "; \
		read answer; \
		if [ "$$answer" != "j" ]; then \
			exit 1; \
		fi; \
	fi; \
	cp $(DAILY_DIR)/template.md $(DAILY_DIR)/$$date.md && \
	echo "âœ“ Neues Tagesprotokoll erstellt: $(DAILY_DIR)/$$date.md"

# Neues Tagesprotokoll fÃ¼r heute erstellen
today:
	@current_date=`date "+%Y%m%d"`; \
	if [ -f "$(DAILY_DIR)/$$current_date.md" ]; then \
		echo "Die Datei $(DAILY_DIR)/$$current_date.md existiert bereits."; \
		echo "MÃ¶chten Sie sie Ã¼berschreiben? (j/n) "; \
		read answer; \
		if [ "$$answer" != "j" ]; then \
			exit 1; \
		fi; \
	fi; \
	cp $(DAILY_DIR)/template.md $(DAILY_DIR)/$$current_date.md; \
	today_date=`date "+%d.%m.%Y"`; \
	sed -i '' "s/\[Datum eintragen\]/$$today_date/" $(DAILY_DIR)/$$current_date.md; \
	echo "âœ“ Neues Tagesprotokoll fÃ¼r heute ($$today_date) erstellt: $(DAILY_DIR)/$$current_date.md"

# Erstellt das PDF fÃ¼r die Workflow-Dokumentation
workflow:
	$(DOCS_DIR)/scripts/better_pdf.sh $(DOCS_DIR)/markdown_latex_workflow.md $(OUTPUT_DIR)/markdown_latex_workflow.pdf

# Installiert die benÃ¶tigten LaTeX-Pakete
install-latex-deps:
	sudo tlmgr install lastpage titlesec babel-german microtype booktabs framed

# Hilfe anzeigen
help:
	@echo "VerfÃ¼gbare Befehle:"
	@echo "  make                - Erstellt alle PDFs"
	@echo "  make months         - Erstellt PDFs fÃ¼r alle Monatsberichte"
	@echo "  make current-month  - Erstellt PDF fÃ¼r einen bestimmten Monat (fragt nach Jahr-Monat)"
	@echo "  make daily          - Erstellt ein PDF fÃ¼r einen tÃ¤glichen Bericht (fragt nach Datum)"
	@echo "  make new-daily      - Erstellt ein neues Tagesprotokoll basierend auf der Vorlage"
	@echo "  make today          - Erstellt ein neues Tagesprotokoll fÃ¼r den aktuellen Tag"
	@echo "  make workflow       - Erstellt das PDF fÃ¼r die Markdown/LaTeX Workflow-Dokumentation"
	@echo "  make install-latex-deps - Installiert die benÃ¶tigten LaTeX-Pakete"
	@echo "  make create-month   - Erstellt automatisch MD- und CSV-Dateien fÃ¼r einen Monat aus Git-Commits"
	@echo "  make git-log        - Erstellt ein Git-Log fÃ¼r einen bestimmten Monat"
	@echo ""
	@echo "Zeiterfassung:"
	@echo "  make                - Erstellt alle Monatsberichte (CSV/MD/PDF) fÃ¼r das aktuelle Jahr"
	@echo "  make clean          - LÃ¶scht alle generierten Dateien des aktuellen Jahres"
	@echo "  make year-reports   - Alternative zu 'make'"
	@echo "  make month-YYYYMM   - Einzelner Monat (z.B. make month-202502)"
	@echo ""
	@echo "  make help           - Zeigt diese Hilfe an"

# Erstelle ein Git-Log fÃ¼r einen bestimmten Monat
git-log:
	@read -p "Jahr-Monat (Format YYYYMM, z.B. 202510 fÃ¼r Oktober 2025): " yearmonth; \
	year=$${yearmonth:0:4}; \
	month=$${yearmonth:4:2}; \
	read -p "Repository-Pfad: " repo_path; \
	if [ ! -d "$$repo_path" ]; then \
		echo "Fehler: Das Repository $$repo_path existiert nicht."; \
		exit 1; \
	fi; \
	cd "$$repo_path" && \
	echo "Git-Commits fÃ¼r $$month/$$year:" && \
	git log --since="$$year-$$month-01" --until="$$year-$$month-31" --pretty=format:"%ad | %s" --date=short | \
	sed 's/ðŸ”’/[SECURITY]/g' | \
	sed 's/ðŸš€/[LAUNCH]/g' | \
	sed 's/ðŸ“Š/[STATS]/g' | \
	sed 's/ðŸ›/[BUG]/g' | \
	sed 's/âœ¨/[FEATURE]/g' | \
	sed 's/ðŸ”¥/[CRITICAL]/g' > "$(MONTH_DIR)/$$yearmonth-git-log.txt" && \
	echo "âœ“ Git-Log erstellt: $(MONTH_DIR)/$$yearmonth-git-log.txt"

# Erstelle automatisch eine Monats-Markdown und CSV-Datei aus Git-Commits
create-month:
	@$(DOCS_DIR)/scripts/create_month.sh



# Allgemeine Regel fÃ¼r beliebige Monate (Format: YYYYMM)
month-%:
	@year_month=$*; \
	year=$${year_month:0:4}; \
	month=$${year_month:4:2}; \
	echo "=== Erstelle Zeiterfassung fÃ¼r $$month/$$year ==="; \
	$(DOCS_DIR)/scripts/create_month.sh $$year $$month; \
	echo "=== Erstelle PDF ==="; \
	pandoc $(MONTH_DIR)/$$year_month.md -o $(OUTPUT_DIR)/$$year_month.pdf --pdf-engine=xelatex -V geometry:margin=2cm -V documentclass=article -V lang=de; \
	echo "âœ… $$month/$$year komplett erstellt:"; \
	echo "   ðŸ“Š CSV: $(MONTH_DIR)/$$year_month.csv"; \
	echo "   ðŸ“„ Markdown: $(MONTH_DIR)/$$year_month.md"; \
	echo "   ðŸ“‘ PDF: $(OUTPUT_DIR)/$$year_month.pdf"