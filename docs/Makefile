# Makefile f√ºr die Erstellung von LaTeX/PDF Dokumenten aus Markdown

# Variablen
DOCS_DIR = /Users/georg/projects/jedsy/jedsy-dev-infrastructure/docs
TIMERECORD_DIR = $(DOCS_DIR)/timerecord
MONTH_DIR = $(TIMERECORD_DIR)/month
DAILY_DIR = $(TIMERECORD_DIR)/daily
OUTPUT_DIR = $(TIMERECORD_DIR)/output
TEMPLATE_DIR = $(DOCS_DIR)/templates
PANDOC = pandoc
TEMPLATE = $(TEMPLATE_DIR)/jedsy-report-template.tex

# Erstelle Ausgabeverzeichnis falls es nicht existiert
$(shell mkdir -p $(OUTPUT_DIR))

# Liste aller Monatsdateien ermitteln (nur .md Dateien)
MONTH_FILES = $(wildcard $(MONTH_DIR)/*.md)
MONTH_PDFS = $(patsubst $(MONTH_DIR)/%.md,$(OUTPUT_DIR)/%.pdf,$(MONTH_FILES))

# Standard-Ziel
all: months workflow

# Alle Monatsberichte erstellen
months: $(MONTH_PDFS)

# Regel f√ºr die Erstellung eines Monats-PDF aus einer .md-Datei
$(OUTPUT_DIR)/%.pdf: $(MONTH_DIR)/%.md
	@echo "Erstelle PDF f√ºr Monat $*"
	@$(DOCS_DIR)/scripts/better_pdf.sh $< $@

# Erstellt das PDF f√ºr den aktuellen Monat (Jahr und Monat werden abgefragt)
current-month:
	@read -p "Jahr-Monat (Format YYYYMM, z.B. 202510 f√ºr Oktober 2025): " yearmonth; \
	if [ ! -f "$(MONTH_DIR)/$$yearmonth.md" ]; then \
		echo "Fehler: Die Datei $(MONTH_DIR)/$$yearmonth.md existiert nicht."; \
		exit 1; \
	fi; \
	$(DOCS_DIR)/scripts/better_pdf.sh $(MONTH_DIR)/$$yearmonth.md $(OUTPUT_DIR)/$$yearmonth.pdf

# Erstellt ein t√§gliches Berichts-PDF
daily:
	@read -p "Datum (Format YYYYMMDD, z.B. 20251014 f√ºr 14. Oktober 2025): " date; \
	if [ ! -f "$(DAILY_DIR)/$$date.md" ]; then \
		echo "Warnung: Die Datei $(DAILY_DIR)/$$date.md existiert nicht."; \
		echo "M√∂chten Sie eine neue Datei basierend auf der Vorlage erstellen? (j/n) "; \
		read answer; \
		if [ "$$answer" = "j" ]; then \
			cp $(DAILY_DIR)/template.md $(DAILY_DIR)/$$date.md; \
			echo "Tagesprotokoll-Vorlage nach $(DAILY_DIR)/$$date.md kopiert."; \
			echo "Bitte f√ºllen Sie die Datei aus und f√ºhren Sie diesen Befehl erneut aus."; \
		fi; \
		exit 1; \
	fi; \
	$(DOCS_DIR)/scripts/better_pdf.sh $(DAILY_DIR)/$$date.md $(OUTPUT_DIR)/$$date.pdf

# Neues Tagesprotokoll erstellen
new-daily:
	@read -p "Datum (Format YYYYMMDD, z.B. 20251014 f√ºr 14. Oktober 2025): " date; \
	if [ -f "$(DAILY_DIR)/$$date.md" ]; then \
		echo "Die Datei $(DAILY_DIR)/$$date.md existiert bereits."; \
		echo "M√∂chten Sie sie √ºberschreiben? (j/n) "; \
		read answer; \
		if [ "$$answer" != "j" ]; then \
			exit 1; \
		fi; \
	fi; \
	cp $(DAILY_DIR)/template.md $(DAILY_DIR)/$$date.md && \
	echo "‚úì Neues Tagesprotokoll erstellt: $(DAILY_DIR)/$$date.md"

# Neues Tagesprotokoll f√ºr heute erstellen
today:
	@current_date=`date "+%Y%m%d"`; \
	if [ -f "$(DAILY_DIR)/$$current_date.md" ]; then \
		echo "Die Datei $(DAILY_DIR)/$$current_date.md existiert bereits."; \
		echo "M√∂chten Sie sie √ºberschreiben? (j/n) "; \
		read answer; \
		if [ "$$answer" != "j" ]; then \
			exit 1; \
		fi; \
	fi; \
	cp $(DAILY_DIR)/template.md $(DAILY_DIR)/$$current_date.md; \
	today_date=`date "+%d.%m.%Y"`; \
	sed -i '' "s/\[Datum eintragen\]/$$today_date/" $(DAILY_DIR)/$$current_date.md; \
	echo "‚úì Neues Tagesprotokoll f√ºr heute ($$today_date) erstellt: $(DAILY_DIR)/$$current_date.md"

# Erstellt das PDF f√ºr die Workflow-Dokumentation
workflow:
	$(DOCS_DIR)/scripts/better_pdf.sh $(DOCS_DIR)/markdown_latex_workflow.md $(OUTPUT_DIR)/markdown_latex_workflow.pdf

# Installiert die ben√∂tigten LaTeX-Pakete
install-latex-deps:
	sudo tlmgr install lastpage titlesec babel-german microtype booktabs framed

# Hilfe anzeigen
help:
	@echo "Verf√ºgbare Befehle:"
	@echo "  make                - Erstellt alle PDFs"
	@echo "  make months         - Erstellt PDFs f√ºr alle Monatsberichte"
	@echo "  make current-month  - Erstellt PDF f√ºr einen bestimmten Monat (fragt nach Jahr-Monat)"
	@echo "  make daily          - Erstellt ein PDF f√ºr einen t√§glichen Bericht (fragt nach Datum)"
	@echo "  make new-daily      - Erstellt ein neues Tagesprotokoll basierend auf der Vorlage"
	@echo "  make today          - Erstellt ein neues Tagesprotokoll f√ºr den aktuellen Tag"
	@echo "  make workflow       - Erstellt das PDF f√ºr die Markdown/LaTeX Workflow-Dokumentation"
	@echo "  make install-latex-deps - Installiert die ben√∂tigten LaTeX-Pakete"
	@echo "  make create-month   - Erstellt automatisch MD- und CSV-Dateien f√ºr einen Monat aus Git-Commits"
	@echo "  make git-log        - Erstellt ein Git-Log f√ºr einen bestimmten Monat"
	@echo "  make help           - Zeigt diese Hilfe an"

# Erstelle ein Git-Log f√ºr einen bestimmten Monat
git-log:
	@read -p "Jahr-Monat (Format YYYYMM, z.B. 202510 f√ºr Oktober 2025): " yearmonth; \
	year=$${yearmonth:0:4}; \
	month=$${yearmonth:4:2}; \
	read -p "Repository-Pfad: " repo_path; \
	if [ ! -d "$$repo_path" ]; then \
		echo "Fehler: Das Repository $$repo_path existiert nicht."; \
		exit 1; \
	fi; \
	cd "$$repo_path" && \
	echo "Git-Commits f√ºr $$month/$$year:" && \
	git log --since="$$year-$$month-01" --until="$$year-$$month-31" --pretty=format:"%ad | %s" --date=short | \
	sed 's/üîí/[SECURITY]/g' | \
	sed 's/üöÄ/[LAUNCH]/g' | \
	sed 's/üìä/[STATS]/g' | \
	sed 's/üêõ/[BUG]/g' | \
	sed 's/‚ú®/[FEATURE]/g' | \
	sed 's/üî•/[CRITICAL]/g' > "$(MONTH_DIR)/$$yearmonth-git-log.txt" && \
	echo "‚úì Git-Log erstellt: $(MONTH_DIR)/$$yearmonth-git-log.txt"

# Erstelle automatisch eine Monats-Markdown und CSV-Datei aus Git-Commits
create-month:
	@$(DOCS_DIR)/scripts/create_month.sh